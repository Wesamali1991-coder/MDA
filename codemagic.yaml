workflows:
  ios_ipa_unsigned:
    name: iOS â€” Unsigned IPA (auto-create platforms)
    environment:
      flutter: stable
      xcode: 15.4
      cocoapods: default
    scripts:
      - name: Bootstrap Flutter project
        script: |
          set -e
          flutter --version
          flutter create .
          flutter pub get
      - name: iOS deps (CocoaPods)
        script: |
          set -e
          cd ios
          rm -rf Pods Podfile.lock || true
          pod repo update
          pod install
          cd ..
      - name: Add iOS usage descriptions (camera/photos)
        script: |
          set -e
          INFO_PLIST="ios/Runner/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSPhotoLibraryUsageDescription string This app needs photo library access to pick chart images." "$INFO_PLIST" || true
          /usr/libexec/PlistBuddy -c "Add :NSCameraUsageDescription string This app may use the camera to capture chart images." "$INFO_PLIST" || true
      - name: Build unsigned IPA
        script: |
          set -e
          flutter build ipa --release --no-codesign \
            --build-name=1.0.0 --build-number=$(date +%Y%m%d%H%M)
      - name: List build outputs
        script: |
          echo "=== iOS build outputs ==="
          ls -R build/ios || true
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/**/*.ipa
